!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.authkeeper=t():e.authkeeper=t()}(self,(()=>(()=>{"use strict";var e={d:(t,r)=>{for(var o in r)e.o(r,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{OAuthClient:()=>n});const r="undefined"!=typeof window,o=class{static generateRandomString(e=28){if(r){const t=new Uint32Array(e);return window.crypto.getRandomValues(t),Array.from(t,(e=>("0"+e.toString(16)).substr(-2))).join("")}{const t=new Uint8Array(e);return require("crypto").randomFillSync(t),Array.from(t,(e=>("0"+e.toString(16)).substr(-2))).join("")}}static base64urlencode(e){let t;return t=r?btoa(String.fromCharCode.apply(null,new Uint8Array(e))):Buffer.from(e).toString("base64"),t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}static async sha256(e){if(r){const t=(new TextEncoder).encode(e),r=await window.crypto.subtle.digest("SHA-256",t);return new Uint8Array(r)}{const t=require("crypto").createHash("sha256");return t.update(e),t.digest()}}static async pkceChallengeFromVerifier(e){const t=await this.sha256(e);return this.base64urlencode(t)}static parseQueryString(e){const t=new URLSearchParams(e),r={};for(let[e,o]of t.entries())r[e]=o;return r}};class n{constructor(e){this.client_id=e.client_id,this.client_secret=e.client_secret,this.redirect_uri=e.redirect_uri,this.authorization_url=e.authorization_url,this.token_url=e.token_url,this.scope=e.scope}async startAuthFlow(){const e=o.generateRandomString();localStorage.setItem("pkce_state",e);const t=o.generateRandomString();localStorage.setItem("pkce_code_verifier",t);const r=await o.pkceChallengeFromVerifier(t),n=`${this.authorization_url}?response_type=code&client_id=${encodeURIComponent(this.client_id)}&state=${encodeURIComponent(e)}&scope=${encodeURIComponent(this.scope)}&redirect_uri=${encodeURIComponent(this.redirect_uri)}&code_challenge=${encodeURIComponent(r)}&code_challenge_method=S256`;window.location=n}async handleCallback(){const e=o.parseQueryString(window.location.search.substring(1));e.error&&alert("Error: "+e.error),e.code&&(localStorage.getItem("pkce_state")!==e.state?alert("Invalid state"):await this.exchangeAuthCodeForToken(e.code))}async exchangeAuthCodeForToken(e){const t=localStorage.getItem("pkce_code_verifier");if(!t)return console.error("Code verifier is missing from localStorage."),null;const r=new URL("/api/v2/",this.token_url).origin,o={client_id:this.client_id,client_secret:this.client_secret,grant_type:"authorization_code",code:e,redirect_uri:this.redirect_uri,code_verifier:t,audience:r},n=await fetch(this.token_url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!n.ok){const e=await n.text();return console.error("Token exchange failed with status:",n.status,"Response:",e),null}let i;try{i=await n.json()}catch(e){return console.error("Error parsing response JSON:",e),null}if(!i)return console.error("No token data returned."),null;localStorage.setItem("auth_token",i.access_token),localStorage.setItem("id_token",i.id_token),localStorage.setItem("expires_in",i.expires_in.toString());const a=`${new URL(this.token_url).origin}/userinfo`,s=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${i.access_token}`}});if(!s.ok){const e=await s.text();return console.error("User info request failed with status:",s.status,"Response:",e),null}let c;try{c=await s.json()}catch(e){return console.error("Error parsing user info response JSON:",e),null}return localStorage.setItem("current_user",JSON.stringify(c)),{auth_token:i.access_token,id_token:i.id_token,expires_in:i.expires_in,user_info:c}}}return t})()));
//# sourceMappingURL=authkeeper.js.map