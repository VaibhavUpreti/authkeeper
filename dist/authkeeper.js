!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.authkeeper=t():e.authkeeper=t()}(self,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{OAuthClient:()=>s});const n="undefined"!=typeof window,r=class{static generateRandomString(e=28){if(n){const t=new Uint32Array(e);return window.crypto.getRandomValues(t),Array.from(t,(e=>("0"+e.toString(16)).substr(-2))).join("")}{const t=new Uint8Array(e);return require("crypto").randomFillSync(t),Array.from(t,(e=>("0"+e.toString(16)).substr(-2))).join("")}}static base64urlencode(e){let t;return t=n?btoa(String.fromCharCode.apply(null,new Uint8Array(e))):Buffer.from(e).toString("base64"),t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}static async sha256(e){if(n){const t=(new TextEncoder).encode(e),n=await window.crypto.subtle.digest("SHA-256",t);return new Uint8Array(n)}{const t=require("crypto").createHash("sha256");return t.update(e),t.digest()}}static async pkceChallengeFromVerifier(e){const t=await this.sha256(e);return this.base64urlencode(t)}static parseQueryString(e){const t=new URLSearchParams(e),n={};for(let[e,r]of t.entries())n[e]=r;return n}};async function o(e,t){const n=localStorage.getItem("pkce_code_verifier");if(!n)return console.error("Code verifier is missing from localStorage."),null;const r={client_id:e.client_id,grant_type:"authorization_code",code:t,redirect_uri:e.redirect_uri,code_verifier:n},o=await fetch(e.token_url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!o.ok)return console.error("Token exchange failed:",await o.text()),null;const i=await o.json();localStorage.setItem("access_token",i.access_token),localStorage.setItem("id_token",i.id_token),localStorage.setItem("expires_in",i.expires_in.toString()),localStorage.setItem("refresh_token",i.refresh_token);const s=await async function(e,t){const n=`${new URL(e.token_url).origin}/userinfo`,r=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(!r.ok)return console.error("User info request failed:",await r.text()),null;try{return await r.json()}catch(e){return console.error("Error parsing user info response JSON:",e),null}}(e,i.access_token);return s?(localStorage.setItem("current_user",JSON.stringify(s)),{access_token:i.access_token,id_token:i.id_token,expires_in:i.expires_in,user_info:s}):null}async function i(e,t){const n=new URLSearchParams({grant_type:"refresh_token",client_id:e.client_id,refresh_token:t}),r=await fetch(e.token_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()});if(!r.ok)return console.error("Refresh token request failed:",await r.text()),null;const o=await r.json();return localStorage.setItem("access_token",o.access_token),localStorage.setItem("id_token",o.id_token),localStorage.setItem("expires_in",o.expires_in.toString()),o}class s{constructor(e,t=function(){return"undefined"!=typeof window&&void 0!==window.document?"browser":"server"}()){this.config=e,this.environment=t}async startAuthFlow(){if("browser"===this.environment||"mobile"===this.environment)return async function(e){const t=r.generateRandomString();localStorage.setItem("pkce_state",t);const n=r.generateRandomString();localStorage.setItem("pkce_code_verifier",n);const o=await r.pkceChallengeFromVerifier(n),i=`${e.authorization_url}?response_type=code&client_id=${encodeURIComponent(e.client_id)}&state=${encodeURIComponent(t)}&scope=${encodeURIComponent(e.scope)}&redirect_uri=${encodeURIComponent(e.redirect_uri)}&code_challenge=${encodeURIComponent(o)}&code_challenge_method=S256`;window.location=i}(this.config);if("server"===this.environment)return async function(e){return`${e.authorization_url}?response_type=code&client_id=${encodeURIComponent(e.client_id)}&scope=${encodeURIComponent(e.scope)}&redirect_uri=${encodeURIComponent(e.redirect_uri)}`}(this.config);throw new Error(`Unknown environment: ${this.environment}`)}async handleCallback(){if("browser"===this.environment||"mobile"===this.environment)return async function(e){const t=r.parseQueryString(window.location.search.substring(1));return t.error?(alert("Error: "+t.error),null):t.code?localStorage.getItem("pkce_state")!==t.state?(alert("Invalid state"),null):o(e,t.code):null}(this.config);if("server"===this.environment)return async function(){throw new Error("Server environment does not directly handle callbacks. Ensure the client sends the code to the server.")}(this.config);throw new Error(`Unknown environment: ${this.environment}`)}async exchangeAuthCodeForToken(e){if("browser"===this.environment||"mobile"===this.environment)return o(this.config,e);if("server"===this.environment)return async function(e,t){const n={client_id:e.client_id,client_secret:e.client_secret,grant_type:"authorization_code",code:t,redirect_uri:e.redirect_uri},r=await fetch(e.token_url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return r.ok?r.json():(console.error("Token exchange failed:",await r.text()),null)}(this.config,e);throw new Error(`Unknown environment: ${this.environment}`)}async refreshAccessToken(e){if("browser"===this.environment||"mobile"===this.environment){const e=localStorage.getItem("refresh_token");return i(this.config,e)}if("server"===this.environment)return i(this.config,e);throw new Error(`Unknown environment: ${this.environment}`)}}return t})()));
//# sourceMappingURL=authkeeper.js.map